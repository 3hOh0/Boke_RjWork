{% extends 'share_layout/base.html' %}
{% load i18n %}
{% load static %}

{% block header %}
    <title>公开收藏夹</title>
{% endblock %}

{% block compress_css %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'interaction/css/interaction.css' %}">
{% endblock %}

{% block content %}
    <div class="container py-5">
        <div class="hero-panel mb-4">
            <div>
                <p class="badge text-bg-success mb-2">发现 · 分享</p>
                <h1 class="mb-2">探索公开收藏夹</h1>
                <p class="text-muted mb-0">看看大家在收藏什么灵感，顺手收藏到自己的收藏夹</p>
            </div>
            <div class="d-flex flex-wrap gap-2 align-items-center">
                <div class="chip-group">
                    <input type="search" id="publicSearchInput" class="form-control" placeholder="按名称/描述搜索" style="min-width: 220px;">
                    <select class="form-select" id="publicSortSelect">
                        <option value="">默认排序</option>
                        <option value="recent">最近更新</option>
                        <option value="count">按文章数</option>
                    </select>
                    <span class="chip active">全部</span>
                </div>
                <a class="btn btn-primary" href="{% url 'interaction:dashboard' %}">管理我的收藏夹</a>
            </div>
        </div>
        <div class="row">
            {% for folder in folders %}
                <div class="col-md-4 mb-4 public-card" data-name="{{ folder.name|lower }}" data-desc="{{ folder.description|default:''|lower }}" data-count="{{ folder.items.count }}" data-updated="{{ folder.updated_time|default:folder.created_time|date:'U' }}">
                    <div class="card h-100 shadow-sm public-folder-card fade-in">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">{{ folder.name }}</h5>
                                <span class="badge bg-light text-dark">文章数 {{ folder.items.count }}</span>
                            </div>
                            <p class="card-text text-muted">{{ folder.description|default:'暂无描述' }}</p>
                            <div class="d-flex align-items-center gap-2">
                                <span class="avatar-dot"></span>
                                <p class="small text-secondary mb-0">
                                    {% if folder.owner.user %}
                                        作者: {{ folder.owner.user.get_username }}
                                    {% else %}
                                        匿名用户
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="card-footer d-flex justify-content-between align-items-center">
                            <span class="badge text-bg-primary">公开</span>
                            <a class="btn btn-sm btn-primary" href="{% url 'interaction:folder_share' folder.share_token %}">
                                查看
                            </a>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="col-12">
                    <div class="alert alert-info">
                        还没有公开收藏夹。成为第一个分享的人吧！
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}

{% block compress_js %}
    {{ block.super }}
    <script>
        (function () {
            const searchInput = document.getElementById('publicSearchInput');
            const sortSelect = document.getElementById('publicSortSelect');
            const cards = Array.from(document.querySelectorAll('.public-card'));
            const row = document.querySelector('.row');

            function applyFilterSort() {
                const keyword = (searchInput && searchInput.value.toLowerCase()) || '';
                const sort = sortSelect ? sortSelect.value : '';
                const visible = [];
                cards.forEach(card => {
                    const name = card.getAttribute('data-name') || '';
                    const desc = card.getAttribute('data-desc') || '';
                    const match = !keyword || name.includes(keyword) || desc.includes(keyword);
                    if (match) {
                        card.classList.remove('d-none');
                        visible.push(card);
                    } else {
                        card.classList.add('d-none');
                    }
                });
                if (sort) {
                    visible.sort((a, b) => {
                        const aUpdated = Number(a.getAttribute('data-updated') || '0');
                        const bUpdated = Number(b.getAttribute('data-updated') || '0');
                        const aCount = Number(a.getAttribute('data-count') || '0');
                        const bCount = Number(b.getAttribute('data-count') || '0');
                        if (sort === 'recent') return bUpdated - aUpdated;
                        if (sort === 'count') return bCount - aCount;
                        return 0;
                    });
                    visible.forEach(card => row.appendChild(card));
                }
            }

            if (searchInput) searchInput.addEventListener('input', applyFilterSort);
            if (sortSelect) sortSelect.addEventListener('change', applyFilterSort);
        })();
    </script>
{% endblock %}
