{% extends "share_layout/base.html" %}
{% load i18n static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
{% block content %}
<div class="container py-5">
    <!-- Hero Section -->
    <div class="mb-5 fade-in">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
            <div>
                <h1 class="fw-bold display-6 mb-2">我的收藏</h1>
                <p class="text-secondary lead mb-0">管理您的个人知识库，整理精彩内容。</p>
            </div>
            <div>
                <button class="btn btn-primary btn-lg shadow-sm" data-bs-toggle="modal"
                    data-bs-target="#createFolderModal">
                    <i class="fas fa-plus me-2"></i>新建收藏夹
                </button>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Sidebar: Folder Navigation -->
        <div class="col-lg-3">
            <div class="card border-0 shadow-sm sticky-md-top" style="top: 2rem; z-index: 10;">
                <div class="card-header bg-white border-0 pt-4 pb-2 px-4">
                    <h6 class="fw-bold text-uppercase text-muted small mb-0">收藏夹</h6>
                </div>
                <div class="card-body p-2">
                    <div class="folder-list list-group list-group-flush">
                        <!-- 'All' option -->
                        <a href="?"
                            class="list-group-item list-group-item-action border-0 rounded-3 px-3 py-2 mb-1 d-flex justify-content-between align-items-center {% if not current_folder_id %}active bg-primary text-white{% endif %}">
                            <span><i class="fas fa-layer-group me-2"></i>全部内容</span>
                        </a>

                        {% for folder in folders %}
                        <a href="?folder_id={{ folder.id }}"
                            class="list-group-item list-group-item-action border-0 rounded-3 px-3 py-2 mb-1 d-flex justify-content-between align-items-center {% if current_folder_id|add:'0' == folder.id %}active bg-primary text-white{% endif %}">
                            <span class="text-truncate">
                                <i
                                    class="fas {% if folder.is_public %}fa-globe-americas{% else %}fa-lock{% endif %} me-2 opacity-75"></i>
                                {{ folder.name }}
                            </span>
                            <span
                                class="badge {% if current_folder_id|add:'0' == folder.id %}bg-white text-primary{% else %}bg-light text-secondary{% endif %} rounded-pill">
                                {{ folder.items.count }}
                            </span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content: Articles -->
        <div class="col-lg-9">
            <!-- Toolbar -->
            <form id="filterForm" method="GET" class="card border-0 shadow-sm mb-4">
                {% if current_folder_id %}
                <input type="hidden" name="folder_id" value="{{ current_folder_id }}">
                {% endif %}
                <div class="card-body p-3">
                    <div class="d-flex flex-column flex-md-row gap-3 justify-content-between">
                        <div class="position-relative flex-grow-1" style="max-width: 400px;">
                            <i
                                class="fas fa-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                            <input type="text" class="form-control ps-5 border-light bg-light" name="q"
                                value="{{ request.GET.q|default:'' }}" placeholder="搜索标题、备注..." autocomplete="off">
                        </div>
                        <div class="d-flex gap-2 align-items-center">
                            <label for="sortSelect" class="text-muted small text-nowrap">排序方式:</label>
                            <select class="form-select border-light bg-light form-select-sm" name="sort_by"
                                id="sortSelect" style="min-width: 140px;" onchange="this.form.submit()">
                                <option value="created_time" {% if request.GET.sort_by=='created_time' %}selected{%
                                    endif %}>最新添加</option>
                                <option value="title" {% if request.GET.sort_by=='title' %}selected{% endif %}>标题排序
                                    (A-Z)</option>
                            </select>
                            <button type="submit" class="btn btn-primary d-none d-md-block">筛选</button>
                        </div>
                    </div>
                </div>
            </form>

            <!-- Articles List -->
            {% if page_obj %}
            <div class="row g-4" id="favoritesList">
                {% for item in page_obj %}
                <div class="col-md-6 fade-in" style="animation-delay: {{ forloop.counter0 }}00ms">
                    <div class="card h-100 border-0 shadow-sm hover-lift transition-all">
                        <div class="card-body p-4 d-flex flex-column">
                            <div class="d-flex justify-content-between mb-3">
                                <a href="?folder_id={{ item.folder.id }}"
                                    class="badge bg-light text-secondary text-decoration-none border">
                                    <i class="fas fa-folder me-1"></i>{{ item.folder.name }}
                                </a>
                                <small class="text-muted">{{ item.created_time|date:"Y/m/d" }}</small>
                            </div>

                            <h5 class="card-title fw-bold mb-3">
                                <a href="{{ item.article.get_absolute_url }}"
                                    class="text-decoration-none text-dark stretched-link">
                                    {{ item.article.title }}
                                </a>
                            </h5>

                            {% if item.note %}
                            <div class="p-3 bg-light rounded-3 mb-3 border-start border-3 border-info">
                                <small class="text-muted d-block fw-bold mb-1">备注:</small>
                                <p class="mb-0 text-secondary italic">{{ item.note }}</p>
                            </div>
                            {% endif %}

                            <div class="mt-auto d-flex justify-content-between align-items-center pt-3 border-top">
                                <span class="badge rounded-pill bg-white border text-secondary">
                                    {{ item.article.category.name }}
                                </span>
                                <button class="btn btn-link text-danger p-0 z-index-10 position-relative"
                                    onclick="event.stopPropagation(); removeFavorite({{ item.id }})" title="移除收藏">
                                    <i class="far fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination with Parameter Retention -->
            {% if page_obj.has_other_pages %}
            {% load nav_utils %}
            <nav aria-label="Page navigation" class="mt-5">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link border-0 shadow-sm rounded-circle mx-1"
                            href="?{% url_replace page=page_obj.previous_page_number %}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                    <li class="page-item active">
                        <span class="page-link border-0 shadow-sm rounded-circle mx-1">{{ num }}</span>
                    </li>
                    {% else %}
                    <li class="page-item">
                        <a class="page-link border-0 shadow-sm rounded-circle mx-1" href="?{% url_replace page=num %}">
                            {{ num }}
                        </a>
                    </li>
                    {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link border-0 shadow-sm rounded-circle mx-1"
                            href="?{% url_replace page=page_obj.next_page_number %}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

            {% else %}
            <div class="text-center py-5">
                <div class="mb-4">
                    <span class="fa-stack fa-3x text-light">
                        <i class="fas fa-circle fa-stack-2x"></i>
                        <i class="fas fa-heart-broken fa-stack-1x text-secondary"></i>
                    </span>
                </div>
                <h4 class="text-secondary">暂无收藏内容</h4>
                <p class="text-muted">赶快去阅读文章并收藏您感兴趣的内容吧！</p>
                <a href="/" class="btn btn-outline-primary mt-3">去浏览文章</a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Styles Fix -->
<style>
    .hover-lift:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1) !important;
    }

    .transition-all {
        transition: all 0.2s ease-in-out;
    }

    .z-index-10 {
        z-index: 10;
    }

    .list-group-item.active {
        background: linear-gradient(135deg, #0d6efd, #0a58ca);
        border-color: transparent;
    }
</style>

<!-- 创建收藏夹模态框 -->
<div class="modal fade" id="createFolderModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-light border-0">
                <h5 class="modal-title fw-bold">新建收藏夹</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="createFolderForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold small text-uppercase">名称</label>
                        <input type="text" class="form-control" name="name" required placeholder="例如：Python 学习笔记">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold small text-uppercase">描述</label>
                        <textarea class="form-control" name="description" rows="3" placeholder="写一句简短的描述..."></textarea>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="is_public" id="publicSwitch">
                        <label class="form-check-label" for="publicSwitch">设为公开收藏夹</label>
                        <div class="form-text text-muted">公开后，任何人都可以通过链接访问此收藏夹。</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 p-4 pt-0">
                <button type="button" class="btn btn-light text-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary px-4" onclick="createFolder()">创建</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 工具函数：获取URL参数
    function getUrlParameter(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }

    // 工具函数：构建带参数的URL
    function buildUrl(params) {
        const urlParams = new URLSearchParams(window.location.search);
        for (const [key, value] of Object.entries(params)) {
            if (value) {
                urlParams.set(key, value);
            } else {
                urlParams.delete(key);
            }
        }
        return `?${urlParams.toString()}`;
    }

    // 初始化：设置排序下拉框的值
    document.addEventListener('DOMContentLoaded', function () {
        const currentSort = getUrlParameter('sort_by');
        if (currentSort) {
            document.getElementById('sortSelect').value = currentSort;
        }

        // 高亮当前选中的文件夹
        const currentFolderId = getUrlParameter('folder_id');
        if (currentFolderId) {
            const folderItems = document.querySelectorAll('.folder-item');
            folderItems.forEach(item => {
                if (item.querySelector(`button[onclick="filterByFolder(${currentFolderId})"]`)) {
                    item.classList.add('bg-light');
                }
            });
        }
    });

    // 排序功能
    document.getElementById('sortSelect').addEventListener('change', function () {
        window.location.href = buildUrl({ 'sort_by': this.value });
    });

    // 文件夹筛选
    function filterByFolder(folderId) {
        // 切换文件夹时，重置页码到1，保留排序，清除分类筛选（可选，视需求而定，这里暂且保留排序）
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('folder_id', folderId);
        urlParams.delete('page'); // 重置页码
        window.location.href = `?${urlParams.toString()}`;
    }

    // 删除收藏
    function removeFavorite(itemId) {
        if (confirm('{% trans "Are you sure you want to remove this favorite?" %}')) {
            fetch(`/interaction/items/${itemId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            }).then(response => response.json())
                .then(data => {
                    if (data.deleted) {
                        location.reload();
                    }
                });
        }
    }

    // 创建收藏夹
    function createFolder() {
        const form = document.getElementById('createFolderForm');
        const formData = new FormData(form);

        fetch('/interaction/folders/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        }).then(response => response.json())
            .then(data => {
                if (data.id) {
                    $('#createFolderModal').modal('hide');
                    location.reload();
                } else {
                    alert('Error creating folder');
                }
            });
    }

    // 搜索功能
    const searchInput = document.getElementById('searchInput');
    let searchTimeout;

    searchInput.addEventListener('input', function () {
        const query = this.value.trim();
        clearTimeout(searchTimeout);

        // 防抖处理
        searchTimeout = setTimeout(() => {
            if (query.length >= 1) {
                searchFavorites(query);
            } else if (query.length === 0) {
                // 如果搜索框清空，重新加载当前页面的原始列表（或者是重置所有AJAX内容）
                // 最简单的做法是刷新页面，或者重新获取当前页数据
                location.reload();
            }
        }, 300);
    });

    function searchFavorites(query) {
        const folderId = getUrlParameter('folder_id');
        const category = getUrlParameter('category');
        const sortBy = document.getElementById('sortSelect').value;

        let url = `/interaction/search/?q=${encodeURIComponent(query)}`;
        if (folderId) url += `&folder_id=${folderId}`;
        if (category) url += `&category=${encodeURIComponent(category)}`;
        if (sortBy) url += `&sort_by=${sortBy}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                updateFavoritesList(data.items);
            });
    }

    function updateFavoritesList(items) {
        const container = document.getElementById('favoritesList');
        container.innerHTML = '';

        if (items.length === 0) {
            container.innerHTML = '<div class="col-12"><div class="alert alert-info">{% trans "No favorites found matching your search." %}</div></div>';
            return;
        }

        items.forEach(item => {
            const col = document.createElement('div');
            col.className = 'col-md-6 mb-4';
            col.innerHTML = `
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-title">
                        <a href="${item.url}" class="text-decoration-none">${item.title}</a>
                    </h6>
                    <p class="card-text text-muted small">
                        <i class="fas fa-folder"></i> ${item.folder_name}<br>
                        <i class="fas fa-calendar"></i> ${item.created_time}
                    </p>
                    ${item.note ? `<p class="card-text border-top pt-2 small"><strong>Note:</strong> ${item.note}</p>` : ''}
                </div>
                <div class="card-footer bg-transparent">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">${item.category}</small>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeFavorite(${item.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
            container.appendChild(col);
        });
    }
</script>
{% endblock %}